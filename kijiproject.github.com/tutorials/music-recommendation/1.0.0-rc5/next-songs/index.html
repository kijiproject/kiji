
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>NextTopSong</title>
    <meta name="description" content="Outputing to a Kiji table in a MapReduce job.">
    <meta name="author" content="WibiData">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/github.css" rel="stylesheet" type="text/css" media="all">
    <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
    <script src="/assets/themes/twitter/vallenato/vallenato.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/assets/themes/twitter/css/vallenato.css" type="text/css" media="screen">
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="http://www.kiji.org">Kiji Community</a>
          <ul class="nav">
            <li class="dropdown">
              <a href="http://www.kiji.org">The Kiji Project</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/features">Features</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="http://www.kiji.org/architecture">Architecture</a>
            </li>
            <li class="dropdown">
              <a href="http://www.kiji.org/getstarted/">Get Started</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Downloads">Downloads</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Installation">Installation</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Quick_Start_Guide">Quick Start Guide</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/get-started-with-maven">Getting Started with Maven</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Training_Services">
                    Training & Services
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="http://www.kiji.org/getinvolved">Get Involved</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Mailing_Lists">Mailing Lists</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Source_Code">Source Code</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Issue_Tracker">Issue Tracking</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Contributing_to_Kiji">
                    Contributing to Kiji
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown active">
              <a href="/">Documentation</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Quick_Start_Guide">Quick Start Guide</a>
                </li>
                <li class="menu-item">
                  <a href="/tutorials.html">Tutorials</a>
                </li>
                <li class="menu-item">
                  <a href="/userguides.html">
                    User Guides
                  </a>
                </li>
                <li class="menu-item">
                  <a href="/apidocs">API Reference</a>
                </li>
                <li class="menu-item">
                  <a href="https://github.com/kijiproject/wiki/wiki">Wiki</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="http://www.kiji.org/blog/">Blog</a>
            </li>
            <li>
              <a href="http://www.kiji.org/aboutkiji">About Kiji</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="content">
        
<div class="row-fluid">
  <div class="span9">
    <div class="page-header">
      <h1>NextTopSong</h1>
    </div>

    <div class="pagination">
      <ul>
    
      
      
    
      

      
        
        
          
        
          
            
            
              <li class="prev">
                <a href="/tutorials/music-recommendation/1.0.0-rc5/sequential-play-count" title="SequentialPlayCount">
                &larr; Previous
                </a>
              </li>
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
      

      
      
        
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
              <li class="next">
                <a href="/tutorials/music-recommendation/1.0.0-rc5/recommendation-producer" title="Music Recommendation Producer">
                Next &rarr;
                </a>
              </li>
            
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
      
      </ul>
    </div>

    <p>This MapReduce job processes the result of the SequentialSong MapReduce job and writes a list of the top songs played after each song (the key) to the corresponding row in the songs table.</p>
<div id='accordion-container'>
  <h2 class='accordion-header'> IdentityMapper.java </h2>
    <div class='accordion-content'>
    <script src='http://gist-it.appspot.com/github/kijiproject/kiji-music/raw/kiji-music-1.0.0-rc5/src/main/java/org/kiji/examples/music/map/IdentityMapper.java'> </script>
    </div>
  <h2 class='accordion-header'> TopNextSongsReducer.java </h2>
   <div class='accordion-content'>
    <script src='http://gist-it.appspot.com/github/kijiproject/kiji-music/raw/kiji-music-1.0.0-rc5/src/main/java/org/kiji/examples/music/reduce/TopNextSongsReducer.java'> </script>
    </div>
</div><h3 style='margin-top:0px;padding-top:10px;'> IdentityMapper.java </h3>
<p>This is a stunning homage to Java boilerplate. This mapper is the identity function; it just emits the same keys and values as it receives without changing them.</p>

<h3 id='topnextsongsreducerjava'>TopNextSongsReducer.java</h3>

<p>The keys passed into this reducer are song ids and the values are SongCount records. In order to find the songs most frequently played after a given song, we need to identify the SongCount records with the largest number of counts, for every key.</p>

<p>To do this efficiently, we will maintain an ordered collection of SongCount records, that has a maximum size. As we iterate through all the values, we will keep the top SongCount records seen so far in our ordered collection.</p>

<p>This reducer</p>

<ul>
<li>Creates an ordered collection that will maintain a list of the top SongCount records, for each key.</li>

<li>Examines each value for a key, and maintains a running list of the top SongCount records seen so far.</li>

<li>Write a TopNextSongs record to the songs table.</li>
</ul>

<h4 id='create_an_ordered_collection'>Create an ordered Collection</h4>

<p>In out setup method, we instantiate a TreeSet that will be reused. TreeSets use their comparator (as opposed to a class&#8217; equals method) to determine if an element is already in the set. In order for our TreeSet to contain multiple SongCount records with the same count, we must make sure that our comparator differentiates SongCount records with the same number of counts, but with different song ids.</p>
<div class='highlight'><pre><code class='java'>  <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>setup</span><span class='o'>(</span><span class='n'>Context</span> <span class='n'>context</span><span class='o'>)</span> <span class='kd'>throws</span> <span class='n'>IOException</span><span class='o'>,</span> <span class='n'>InterruptedException</span> <span class='o'>{</span>
    <span class='kd'>super</span><span class='o'>.</span><span class='na'>setup</span><span class='o'>(</span><span class='n'>context</span><span class='o'>);</span> <span class='c1'>// Any time you override setup, call super.setup(context);</span>
    <span class='n'>mTopSongs</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>TopSongs</span><span class='o'>();</span>
    <span class='c1'>// This TreeSet will keep track of the &quot;largest&quot; SongCount objects seen so far. Two SongCount</span>
    <span class='c1'>// objects, song1 and song2, can be compared and the object with the largest value in the field</span>
    <span class='c1'>// count will the declared the largest object.</span>
    <span class='n'>mTopNextSongs</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>TreeSet</span><span class='o'>&lt;</span><span class='n'>SongCount</span><span class='o'>&gt;(</span><span class='k'>new</span> <span class='n'>Comparator</span><span class='o'>&lt;</span><span class='n'>SongCount</span><span class='o'>&gt;()</span> <span class='o'>{</span>
      <span class='nd'>@Override</span>
      <span class='kd'>public</span> <span class='kt'>int</span> <span class='nf'>compare</span><span class='o'>(</span><span class='n'>SongCount</span> <span class='n'>song1</span><span class='o'>,</span> <span class='n'>SongCount</span> <span class='n'>song2</span><span class='o'>)</span> <span class='o'>{</span>
        <span class='k'>if</span> <span class='o'>(</span><span class='n'>song1</span><span class='o'>.</span><span class='na'>getCount</span><span class='o'>().</span><span class='na'>compareTo</span><span class='o'>(</span><span class='n'>song2</span><span class='o'>.</span><span class='na'>getCount</span><span class='o'>())</span> <span class='o'>==</span> <span class='mi'>0</span><span class='o'>)</span> <span class='o'>{</span>
          <span class='k'>return</span> <span class='n'>song1</span><span class='o'>.</span><span class='na'>getSongId</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>().</span><span class='na'>compareTo</span><span class='o'>(</span><span class='n'>song2</span><span class='o'>.</span><span class='na'>getSongId</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>());</span>
        <span class='o'>}</span> <span class='k'>else</span> <span class='o'>{</span>
          <span class='k'>return</span> <span class='n'>song1</span><span class='o'>.</span><span class='na'>getCount</span><span class='o'>().</span><span class='na'>compareTo</span><span class='o'>(</span><span class='n'>song2</span><span class='o'>.</span><span class='na'>getCount</span><span class='o'>());</span>
        <span class='o'>}</span>
      <span class='o'>}</span>
    <span class='o'>});</span>
  <span class='o'>}</span>
</code></pre></div>
<h4 id='maintain_a_collection_of_the_top_songcount_records'>Maintain a collection of the top SongCount records</h4>

<p>To find the top N songs, we iterate through the values associated with a given key, adding that value to our set, and then removing the smallest value if our set is larger than the number of top SongCount records we want to find.</p>

<p>It is worth pointing out that when you call value.datum(), the <em>same</em> SongCount record, with different fields, will be returned. Many Hadoop projects reuse objects, so be aware! To get around the problem that this creates with trying to use a set, we create a new SongCount record for each value using SongCount&#8217;s builder method.</p>
<div class='highlight'><pre><code class='java'>  <span class='kd'>protected</span> <span class='kt'>void</span> <span class='nf'>reduce</span><span class='o'>(</span><span class='n'>AvroKey</span><span class='o'>&lt;</span><span class='n'>CharSequence</span><span class='o'>&gt;</span> <span class='n'>key</span><span class='o'>,</span> <span class='n'>Iterable</span><span class='o'>&lt;</span><span class='n'>AvroValue</span><span class='o'>&lt;</span><span class='n'>SongCount</span><span class='o'>&gt;&gt;</span> <span class='n'>values</span><span class='o'>,</span>
      <span class='n'>KijiTableContext</span> <span class='n'>context</span><span class='o'>)</span> <span class='kd'>throws</span> <span class='n'>IOException</span> <span class='o'>{</span>
    <span class='c1'>// We are reusing objects, so we should make sure they are cleared for each new key.</span>
    <span class='n'>mTopNextSongs</span><span class='o'>.</span><span class='na'>clear</span><span class='o'>();</span>

    <span class='c1'>// Iterate through the song counts and track the top ${mNumberOfTopSongs} counts.</span>
    <span class='k'>for</span> <span class='o'>(</span><span class='n'>AvroValue</span><span class='o'>&lt;</span><span class='n'>SongCount</span><span class='o'>&gt;</span> <span class='n'>value</span> <span class='o'>:</span> <span class='n'>values</span><span class='o'>)</span> <span class='o'>{</span>
      <span class='c1'>// Remove AvroValue wrapper.</span>
      <span class='n'>SongCount</span> <span class='n'>currentSongCount</span> <span class='o'>=</span> <span class='n'>SongCount</span><span class='o'>.</span><span class='na'>newBuilder</span><span class='o'>(</span><span class='n'>value</span><span class='o'>.</span><span class='na'>datum</span><span class='o'>()).</span><span class='na'>build</span><span class='o'>();</span>

      <span class='n'>mTopNextSongs</span><span class='o'>.</span><span class='na'>add</span><span class='o'>(</span><span class='n'>currentSongCount</span><span class='o'>);</span>
      <span class='c1'>// If we now have too many elements, remove the element with the smallest count.</span>
      <span class='k'>if</span> <span class='o'>(</span><span class='n'>mTopNextSongs</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>&gt;</span> <span class='n'>mNumberOfTopSongs</span><span class='o'>)</span> <span class='o'>{</span>
        <span class='n'>mTopNextSongs</span><span class='o'>.</span><span class='na'>pollFirst</span><span class='o'>();</span>
      <span class='o'>}</span>
    <span class='o'>}</span>
    <span class='c1'>// Set the field of mTopSongs to be a list of SongCounts corresponding to the top songs played</span>
    <span class='c1'>// next for this key/song.</span>
    <span class='n'>mTopSongs</span><span class='o'>.</span><span class='na'>setTopSongs</span><span class='o'>(</span><span class='n'>Lists</span><span class='o'>.</span><span class='na'>newArrayList</span><span class='o'>(</span><span class='n'>mTopNextSongs</span><span class='o'>));</span>
</code></pre></div>
<h4 id='write_topnextsongs_to_the_songs_table'>Write TopNextSongs to the songs table.</h4>

<p>We can write the list of top next songs to the &#8220;info:top_next_songs&#8221; column using context.put(). The only thing to remember witht his method, is that the first arguement is expected to be an entityId. Luckily, context also contains methods for generating EntityIds.</p>
<div class='highlight'><pre><code class='java'>    <span class='o'>...</span>
    <span class='c1'>// Write this to the song table.</span>
    <span class='n'>context</span><span class='o'>.</span><span class='na'>put</span><span class='o'>(</span><span class='n'>context</span><span class='o'>.</span><span class='na'>getEntityId</span><span class='o'>(</span><span class='n'>key</span><span class='o'>.</span><span class='na'>datum</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>()),</span> <span class='s'>&quot;info&quot;</span><span class='o'>,</span> <span class='s'>&quot;top_next_songs&quot;</span><span class='o'>,</span> <span class='n'>mTopSongs</span><span class='o'>);</span>
  <span class='o'>}</span>
</code></pre></div><div id='accordion-container'>
  <h2 class='accordion-header'> TestTopNextSongsPipeline.java </h2>
    <div class='accordion-content'>
    <script src='http://gist-it.appspot.com/github/kijiproject/kiji-music/raw/kiji-music-1.0.0-rc5/src/test/java/org/kiji/examples/music/TestTopNextSongsPipeline.java'> </script>
  </div>
</div><h3 style='margin-top:0px;padding-top:10px;'> TestTopNextSongsPipeline.java </h3>
<p>Two jobs are constructed during this test and run one after another. The first job outputs to an intermediate Avro container file (Add link to relevant userguide section) written to the local file system which is used as input by the second job. Each of the jobs is configured using a job builder:</p>
<div class='highlight'><pre><code class='java'>  <span class='c1'>// Configure and run job.</span>
  <span class='kd'>final</span> <span class='n'>File</span> <span class='n'>outputDir</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>File</span><span class='o'>(</span><span class='n'>getLocalTempDir</span><span class='o'>(),</span> <span class='s'>&quot;output.sequence_file&quot;</span><span class='o'>);</span>
  <span class='kd'>final</span> <span class='n'>Path</span> <span class='n'>path</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>Path</span><span class='o'>(</span><span class='s'>&quot;file://&quot;</span> <span class='o'>+</span> <span class='n'>outputDir</span><span class='o'>);</span>
  <span class='c1'>// Configure first job.</span>
  <span class='kd'>final</span> <span class='n'>MapReduceJob</span> <span class='n'>mrjob1</span> <span class='o'>=</span> <span class='n'>KijiGatherJobBuilder</span><span class='o'>.</span><span class='na'>create</span><span class='o'>()</span>
      <span class='o'>.</span><span class='na'>withConf</span><span class='o'>(</span><span class='n'>getConf</span><span class='o'>())</span>
      <span class='o'>.</span><span class='na'>withGatherer</span><span class='o'>(</span><span class='n'>SequentialPlayCounter</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>withReducer</span><span class='o'>(</span><span class='n'>SequentialPlayCountReducer</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>withInputTable</span><span class='o'>(</span><span class='n'>mUserTableURI</span><span class='o'>)</span>
      <span class='c1'>// Note: the local map/reduce job runner does not allow more than one reducer:</span>
      <span class='o'>.</span><span class='na'>withOutput</span><span class='o'>(</span><span class='k'>new</span> <span class='n'>AvroKeyValueMapReduceJobOutput</span><span class='o'>(</span><span class='n'>path</span><span class='o'>,</span> <span class='mi'>1</span><span class='o'>))</span>
      <span class='o'>.</span><span class='na'>build</span><span class='o'>();</span>
  <span class='c1'>// Configure second job.</span>
  <span class='kd'>final</span> <span class='n'>MapReduceJobOutput</span> <span class='n'>tableOutput</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>DirectKijiTableMapReduceJobOutput</span><span class='o'>(</span><span class='n'>mSongTableURI</span><span class='o'>,</span> <span class='mi'>1</span><span class='o'>);</span>
  <span class='kd'>final</span> <span class='n'>MapReduceJob</span> <span class='n'>mrjob2</span> <span class='o'>=</span> <span class='n'>KijiMapReduceJobBuilder</span><span class='o'>.</span><span class='na'>create</span><span class='o'>()</span>
      <span class='o'>.</span><span class='na'>withConf</span><span class='o'>(</span><span class='n'>getConf</span><span class='o'>())</span>
      <span class='o'>.</span><span class='na'>withInput</span><span class='o'>(</span><span class='k'>new</span> <span class='n'>AvroKeyValueMapReduceJobInput</span><span class='o'>(</span><span class='n'>path</span><span class='o'>))</span>
      <span class='o'>.</span><span class='na'>withMapper</span><span class='o'>(</span><span class='n'>IdentityMapper</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>withReducer</span><span class='o'>(</span><span class='n'>TopNextSongsReducer</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>withOutput</span><span class='o'>(</span><span class='n'>tableOutput</span><span class='o'>).</span><span class='na'>build</span><span class='o'>();</span>

  <span class='c1'>// Run both jobs and confirm that they are successful.</span>
  <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>mrjob1</span><span class='o'>.</span><span class='na'>run</span><span class='o'>());</span>
  <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>mrjob2</span><span class='o'>.</span><span class='na'>run</span><span class='o'>());</span>
</code></pre></div>
<p>The results of these two jobs end up being written to a Kiji table. To validate the output data a KijiTableReader is used to read the records in question.</p>
<div class='highlight'><pre><code class='java'>  <span class='n'>mSongTable</span> <span class='o'>=</span> <span class='n'>getKiji</span><span class='o'>().</span><span class='na'>openTable</span><span class='o'>(</span><span class='n'>songTableName</span><span class='o'>);</span>
  <span class='n'>mSongTableReader</span> <span class='o'>=</span> <span class='n'>mSongTable</span><span class='o'>.</span><span class='na'>openTableReader</span><span class='o'>();</span>

  <span class='c1'>// ...</span>

  <span class='n'>KijiDataRequest</span> <span class='n'>request</span> <span class='o'>=</span> <span class='n'>KijiDataRequest</span><span class='o'>.</span><span class='na'>builder</span><span class='o'>()</span>
      <span class='o'>.</span><span class='na'>addColumns</span><span class='o'>(</span><span class='n'>ColumnsDef</span><span class='o'>.</span><span class='na'>create</span><span class='o'>()</span>
          <span class='o'>.</span><span class='na'>withMaxVersions</span><span class='o'>(</span><span class='n'>Integer</span><span class='o'>.</span><span class='na'>MAX_VALUE</span><span class='o'>)</span>
          <span class='o'>.</span><span class='na'>add</span><span class='o'>(</span><span class='s'>&quot;info&quot;</span><span class='o'>,</span> <span class='s'>&quot;top_next_songs&quot;</span><span class='o'>))</span>
      <span class='o'>.</span><span class='na'>build</span><span class='o'>();</span>

  <span class='n'>TopSongs</span> <span class='n'>valuesForSong1</span> <span class='o'>=</span> <span class='n'>mSongTableReader</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='n'>mSongTable</span><span class='o'>.</span><span class='na'>getEntityId</span><span class='o'>(</span><span class='s'>&quot;song-1&quot;</span><span class='o'>),</span> <span class='n'>request</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>getMostRecentValue</span><span class='o'>(</span><span class='s'>&quot;info&quot;</span><span class='o'>,</span> <span class='s'>&quot;top_next_songs&quot;</span><span class='o'>);</span>
  <span class='n'>assertEquals</span><span class='o'>(</span><span class='s'>&quot;Wrong number of most popular songs played next for song-1&quot;</span><span class='o'>,</span> <span class='mi'>3</span><span class='o'>,</span>
      <span class='n'>valuesForSong1</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>size</span><span class='o'>());</span>

  <span class='n'>TopSongs</span> <span class='n'>valuesForSong2</span> <span class='o'>=</span> <span class='n'>mSongTableReader</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='n'>mSongTable</span><span class='o'>.</span><span class='na'>getEntityId</span><span class='o'>(</span><span class='s'>&quot;song-2&quot;</span><span class='o'>),</span> <span class='n'>request</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>getMostRecentValue</span><span class='o'>(</span><span class='s'>&quot;info&quot;</span><span class='o'>,</span> <span class='s'>&quot;top_next_songs&quot;</span><span class='o'>);</span>
  <span class='n'>LOG</span><span class='o'>.</span><span class='na'>info</span><span class='o'>(</span><span class='s'>&quot;the list of song counts {}&quot;</span><span class='o'>,</span> <span class='n'>valuesForSong2</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>());</span>
  <span class='n'>assertEquals</span><span class='o'>(</span><span class='s'>&quot;Wrong number of most popular songs played next for song-2&quot;</span><span class='o'>,</span> <span class='mi'>2</span><span class='o'>,</span>
      <span class='n'>valuesForSong2</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>size</span><span class='o'>());</span>

  <span class='n'>TopSongs</span> <span class='n'>valuesForSong8</span> <span class='o'>=</span> <span class='n'>mSongTableReader</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='n'>mSongTable</span><span class='o'>.</span><span class='na'>getEntityId</span><span class='o'>(</span><span class='s'>&quot;song-8&quot;</span><span class='o'>),</span> <span class='n'>request</span><span class='o'>)</span>
      <span class='o'>.</span><span class='na'>getMostRecentValue</span><span class='o'>(</span><span class='s'>&quot;info&quot;</span><span class='o'>,</span> <span class='s'>&quot;top_next_songs&quot;</span><span class='o'>);</span>
  <span class='n'>LOG</span><span class='o'>.</span><span class='na'>info</span><span class='o'>(</span><span class='s'>&quot;the list of song counts {}&quot;</span><span class='o'>,</span> <span class='n'>valuesForSong2</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>());</span>
  <span class='n'>assertEquals</span><span class='o'>(</span><span class='s'>&quot;Wrong number of most popular songs played next for song-8&quot;</span><span class='o'>,</span> <span class='mi'>1</span><span class='o'>,</span>
      <span class='n'>valuesForSong8</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>size</span><span class='o'>());</span>
  <span class='n'>assertEquals</span><span class='o'>(</span><span class='s'>&quot;The onyl song played aftert song-8 is song-1.&quot;</span><span class='o'>,</span> <span class='s'>&quot;song-1&quot;</span><span class='o'>,</span>
      <span class='n'>valuesForSong8</span><span class='o'>.</span><span class='na'>getTopSongs</span><span class='o'>().</span><span class='na'>get</span><span class='o'>(</span><span class='mi'>0</span><span class='o'>).</span><span class='na'>getSongId</span><span class='o'>().</span><span class='na'>toString</span><span class='o'>());</span>
</code></pre></div>
<h3 id='running_the_example'>Running the Example</h3>
<div class='userinput'>

<div class='highlight'><pre><code class='bash'>kiji mapreduce <span class='se'>\</span>
    --mapper<span class='o'>=</span>org.kiji.examples.music.map.IdentityMapper <span class='se'>\</span>
    --reducer<span class='o'>=</span>org.kiji.examples.music.reduce.TopNextSongsReducer <span class='se'>\</span>
    --input<span class='o'>=</span><span class='s2'>&quot;format=avrokv file=output.sequentialPlayCount&quot;</span> <span class='se'>\</span>
    --output<span class='o'>=</span><span class='s2'>&quot;format=kiji table=${KIJI}/songs nsplits=1&quot;</span> <span class='se'>\</span>
    --lib<span class='o'>=</span><span class='k'>${</span><span class='nv'>LIBS_DIR</span><span class='k'>}</span>
</code></pre></div>

</div>
<h4 id='verify'>Verify</h4>

<p>Since we write TopNextSongs back to the Kiji table, we can use the Kiji command-line tools to inspect our Kiji tables.</p>
<div class='userinput'>

<div class='highlight'><pre><code class='bash'>kiji scan <span class='k'>${</span><span class='nv'>KIJI</span><span class='k'>}</span>/songs/info:top_next_songs --max-rows<span class='o'>=</span>3
</code></pre></div>

</div>
<pre><code>entity-id=&#39;song-32&#39; [1361564627564] info:top_next_songs
                             {&quot;topSongs&quot;: [{&quot;song_id&quot;: &quot;song-37&quot;, &quot;count&quot;: 10}, {&quot;song_id&quot;: &quot;song-34&quot;, &quot;count&quot;: 11}, {&quot;song_id&quot;: &quot;song-30&quot;, &quot;count&quot;: 18}]}

entity-id=&#39;song-49&#39; [1361564627741] info:top_next_songs
                             {&quot;topSongs&quot;: [{&quot;song_id&quot;: &quot;song-46&quot;, &quot;count&quot;: 10}, {&quot;song_id&quot;: &quot;song-41&quot;, &quot;count&quot;: 20}, {&quot;song_id&quot;: &quot;song-40&quot;, &quot;count&quot;: 27}]}

entity-id=&#39;song-36&#39; [1361564627591] info:top_next_songs
                             {&quot;topSongs&quot;: [{&quot;song_id&quot;: &quot;song-32&quot;, &quot;count&quot;: 11}, {&quot;song_id&quot;: &quot;song-35&quot;, &quot;count&quot;: 15}, {&quot;song_id&quot;: &quot;song-30&quot;, &quot;count&quot;: 27}]}</code></pre>

    <div class="pagination">
      <ul>
    
      
      
    
      

      
        
        
          
        
          
            
            
              <li class="prev">
                <a href="/tutorials/music-recommendation/1.0.0-rc5/sequential-play-count" title="SequentialPlayCount">
                &larr; Previous
                </a>
              </li>
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
      

      
      
        
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
              <li class="next">
                <a href="/tutorials/music-recommendation/1.0.0-rc5/recommendation-producer" title="Music Recommendation Producer">
                Next &rarr;
                </a>
              </li>
            
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
      
      </ul>
    </div>
  </div>

  <div class="span3">
    
      
      
    
    <div class="side-toc">
    <div class="side-toc-inner">
      <h3>Music Recommendation Tutorial</h3>
      <ul>
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/music-overview">Overview</a>
                  
                </li>
              
            
          
            
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/music-setup">Setup</a>
                  
                </li>
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/bulk-importing">Bulk Importing</a>
                  
                </li>
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/play-count">PlayCount</a>
                  
                </li>
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/sequential-play-count">SequentialPlayCount</a>
                  
                </li>
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
                <li>
                  
                    <b>NextTopSong</b>
                  
                </li>
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/music-recommendation/1.0.0-rc5/recommendation-producer">Music Recommendation Producer</a>
                  
                </li>
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
      </ul>
      <h3>Need Help?</h3>
      <ul>
        <li>
      <a class="btn btn-info"  href="https://groups.google.com/a/kiji.org/forum/?fromgroups#!forum/user">User Group Mailing List</a>
        </li>
        <li>
      <a class="btn btn-warning" href="https://jira.kiji.org/secure/CreateIssueDetails!init.jspa?pid=10004&issuetype=1&priority=3&components=10010&summary=Reported%20Docs%20Error:%20NextTopSong&description=Please%20describe%20the%20issue.%0a%0aurl:%20/tutorials/music-recommendation/1.0.0-rc5/next-songs"> Report an Error in Docs </a> 
        </li>
    </ul>
    </div>
</div>

  </div>
</div>


      </div>

      <footer>
        <hr/>
        <p>&copy; Kiji Community</p>
      </footer>
    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35866189-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

